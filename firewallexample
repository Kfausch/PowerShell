#!/bin/bash
# rc.firewall - stateful firewall + NAT
# WAN (external) = ens192  (10.240.101.85)
# LAN (internal) = ens224  (192.168.10.1)

# Flush existing rules
iptables -F
iptables -t nat -F
iptables -X

# Enable IPv4 forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

# Default policies (lockdown)
iptables -P INPUT   DROP
iptables -P FORWARD DROP
iptables -P OUTPUT  DROP

# -------------------------------------------------------------------
# Base rules
# -------------------------------------------------------------------

# Allow loopback
iptables -A INPUT  -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Allow established/related traffic
iptables -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# NAT for traffic going out to the Internet
iptables -t nat -A POSTROUTING -o ens192 -j MASQUERADE

# -------------------------------------------------------------------
# ICMP (ping)
# -------------------------------------------------------------------

# Firewall itself can ping out
iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A INPUT  -p icmp --icmp-type echo-reply   -j ACCEPT

# LAN clients can ping through firewall
iptables -A FORWARD -i ens224 -o ens192 -p icmp --icmp-type echo-request -j ACCEPT
iptables -A FORWARD -i ens192 -o ens224 -p icmp --icmp-type echo-reply   -j ACCEPT

# -------------------------------------------------------------------
# DNS (firewall + clients)
# -------------------------------------------------------------------

# Firewall -> Internet DNS
iptables -A OUTPUT -o ens192 -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o ens192 -p tcp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT  -i ens192 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
iptables -A INPUT  -i ens192 -p tcp --sport 53 -m state --state ESTABLISHED -j ACCEPT

# LAN clients -> Internet DNS through firewall
iptables -A FORWARD -i ens224 -o ens192 -p udp --dport 53 -j ACCEPT
iptables -A FORWARD -i ens224 -o ens192 -p tcp --dport 53 -j ACCEPT
iptables -A FORWARD -i ens192 -o ens224 -p udp --sport 53 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i ens192 -o ens224 -p tcp --sport 53 -m state --state ESTABLISHED,RELATED -j ACCEPT

# -------------------------------------------------------------------
# HTTP / HTTPS
# -------------------------------------------------------------------

# (A) Firewall box itself: yum, curl, browser, etc.
iptables -A OUTPUT -o ens192 -p tcp --dport 80  -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o ens192 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT  -i ens192 -p tcp --sport 80  -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT  -i ens192 -p tcp --sport 443 -m state --state ESTABLISHED,RELATED -j ACCEPT

# (B) LAN clients -> Internet via firewall
iptables -A FORWARD -i ens224 -o ens192 -p tcp --dport 80  -j ACCEPT
iptables -A FORWARD -i ens224 -o ens192 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -i ens192 -o ens224 -p tcp --sport 80  -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i ens192 -o ens224 -p tcp --sport 443 -m state --state ESTABLISHED,RELATED -j ACCEPT

# -------------------------------------------------------------------
# SSH (examples – adjust to your lab requirements)
# -------------------------------------------------------------------

# Allow SSH from LAN to firewall
iptables -A INPUT  -i ens224 -p tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -o ens224 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

# Uncomment if you also need SSH from WAN to firewall:
# iptables -A INPUT  -i ens192 -p tcp --dport 22 -j ACCEPT
# iptables -A OUTPUT -o ens192 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

# -------------------------------------------------------------------
# FTP to firewall itself (per lab – optional)
# -------------------------------------------------------------------

iptables -A INPUT  -i ens192 -p tcp --dport 21 -j ACCEPT
iptables -A INPUT  -i ens224 -p tcp --dport 21 -j ACCEPT
iptables -A OUTPUT -o ens192 -p tcp --sport 21 -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o ens224 -p tcp --sport 21 -m state --state ESTABLISHED -j ACCEPT

# active FTP data channel
iptables -A INPUT  -i ens192 -p tcp --dport 20 -j ACCEPT
iptables -A INPUT  -i ens224 -p tcp --dport 20 -j ACCEPT
iptables -A OUTPUT -o ens192 -p tcp --sport 20 -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o ens224 -p tcp --sport 20 -m state --state ESTABLISHED -j ACCEPT
