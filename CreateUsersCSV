Import-Module ActiveDirectory

# Set CSV path
$csvPath = "C:\Users\Administrator\Downloads\AD Build\ImportUsers.csv"
$users = Import-Csv -Path $csvPath

foreach ($line in $users) {
    # Validate required fields
    if (-not $line.Given -or -not $line.Surname -or -not $line.Path -or -not $line.department) {
        Write-Host "Skipping invalid row (missing required fields): $($line | Out-String)" -ForegroundColor Yellow
        continue
    }

    # Construct values
    $FullName = "$($line.Given) $($line.Surname)"
    $SamAccountName = "$($line.Given).$($line.Surname)"
    $UPN = "$($line.Given).$($line.Surname)@kfausch.local"
    $GroupName = "$($line.department)_Group"

    Write-Host "Creating user: $FullName, Sam: $SamAccountName, UPN: $UPN, Path: $($line.Path), Group: $GroupName" -ForegroundColor Cyan

    # Check if user already exists
    if (Get-ADUser -Filter { SamAccountName -eq $SamAccountName }) {
        Write-Host "User $SamAccountName already exists. Skipping..." -ForegroundColor Yellow
        continue
    }

    # Create user
    try {
        New-ADUser `
            -Name $FullName `
            -GivenName $line.Given `
            -Surname $line.Surname `
            -SamAccountName $SamAccountName `
            -UserPrincipalName $UPN `
            -DisplayName $FullName `
            -EmailAddress $line.Email `
            -Department $line.department `
            -Path $line.Path `
            -OfficePhone $line.OfficePhone `
            -Company $line.Company `
            -Enabled $true `
            -AccountPassword (ConvertTo-SecureString "P@ssword" -AsPlainText -Force)
        
        Write-Host "User $FullName created successfully." -ForegroundColor Green
    } catch {
        Write-Host "Failed to create user $FullName: $_" -ForegroundColor Red
        continue
    }

    # Add to group if it exists
    if (Get-ADGroup -Filter { Name -eq $GroupName }) {
        try {
            Add-ADGroupMember -Identity $GroupName -Members $SamAccountName
            Write-Host "Added $SamAccountName to group $GroupName." -ForegroundColor Green
        } catch {
            Write-Host "Failed to add $SamAccountName to group $GroupName: $_" -ForegroundColor Red
        }
    } else {
        Write-Host "Group $GroupName does not exist. Skipping group assignment." -ForegroundColor Yellow
    }
}
